# ============================================================
# ALPHA-PRIME v2.0 - Pytest Configuration
# ============================================================
# Centralized test configuration for pytest framework.
#
# Run tests:
#   pytest                                  # All tests
#   pytest tests/unit/                      # Unit tests only
#   pytest -m "not slow"                    # Skip slow tests
#   pytest -v --cov=. --cov-report=html     # With coverage
#   pytest -n auto                          # Parallel execution (xdist)
#
# Test markers:
#   @pytest.mark.unit              # Fast unit tests
#   @pytest.mark.integration       # Integration tests
#   @pytest.mark.slow              # Slow-running tests
#   @pytest.mark.api               # Tests calling external APIs
#   @pytest.mark.requires_keys     # Tests needing API keys
# ============================================================

[pytest]

# ──────────────────────────────────────────────────────────
# TEST DISCOVERY
# ──────────────────────────────────────────────────────────
# Where to find tests
testpaths =
    tests

# Test file patterns
python_files =
    test_*.py
    *_test.py

# Test class patterns
python_classes =
    Test*

# Test function patterns
python_functions =
    test_*


# ──────────────────────────────────────────────────────────
# VERSION REQUIREMENTS
# ──────────────────────────────────────────────────────────
minversion = 7.0


# ──────────────────────────────────────────────────────────
# DEFAULT COMMAND LINE OPTIONS
# ──────────────────────────────────────────────────────────
addopts =
    -ra
    --strict-markers
    --strict-config
    --showlocals
    --cov=.
    --cov-report=term-missing:skip-covered
    --cov-report=html
    --cov-report=xml
    --cov-branch
    --maxfail=3
    --tb=short
    --disable-warnings
    --color=yes

# Explanation of key options:
# -ra: Summary of all test outcomes
# --strict-markers: Fail on unknown markers
# --strict-config: Fail on config issues
# --showlocals: Show locals in tracebacks
# --maxfail=3: Stop after 3 failures
# --tb=short: Shorter tracebacks
# --disable-warnings: Cleaner output (warnings still logged if needed)


# ──────────────────────────────────────────────────────────
# CUSTOM TEST MARKERS
# ──────────────────────────────────────────────────────────
markers =
    unit: Fast unit tests (< 1 second)
    integration: Integration tests (may be slower)
    slow: Slow-running tests (> 5 seconds)
    api: Tests that call external APIs
    requires_keys: Tests requiring API keys in .env
    requires_network: Tests requiring internet connection
    smoke: Smoke tests (quick validation of critical paths)
    regression: Regression tests for previously fixed bugs
    wip: Work in progress (not ready for CI)
    skip_ci: Skip in CI/CD pipeline
    portfolio: Tests for portfolio module and P&L calculations
    risk: Tests for risk management and circuit breakers
    oracle: Tests for Oracle / GPT-4o integration
    data: Tests for data engine and technical indicators
    research: Tests for research engine and intel aggregation

# Usage examples:
# Run only fast tests:      pytest -m unit
# Skip slow tests:          pytest -m "not slow"
# API tests only:           pytest -m api
# Unit + integration:       pytest -m "unit or integration"
# Everything except slow:   pytest -m "not slow"


# ──────────────────────────────────────────────────────────
# WARNING FILTERS
# ──────────────────────────────────────────────────────────
filterwarnings =
    error
    ignore::UserWarning
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    ignore::FutureWarning
    ignore:.*pandas.*:FutureWarning
    ignore:.*yfinance.*:FutureWarning
    ignore:.*streamlit.*:DeprecationWarning
    ignore::pytest.PytestUnraisableExceptionWarning

# Explanation:
# error: Treat warnings as errors by default
# Specific ignores reduce noise from third-party libs


# ──────────────────────────────────────────────────────────
# LOGGING CONFIGURATION
# ──────────────────────────────────────────────────────────
log_cli = true
log_cli_level = INFO
log_cli_format = [%(asctime)s] [%(levelname)8s] %(name)s - %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = logs/pytest.log
log_file_level = DEBUG
log_file_format = [%(asctime)s] [%(levelname)8s] %(name)s - %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S

# Indent multi-line log messages for readability
log_auto_indent = true


# ──────────────────────────────────────────────────────────
# TIMEOUT SETTINGS
# ──────────────────────────────────────────────────────────
# Requires pytest-timeout plugin
timeout = 300
timeout_method = thread

# Explanation:
# timeout = 300: Fail tests running longer than 5 minutes
# timeout_method = thread: Compatible with most platforms


# ──────────────────────────────────────────────────────────
# PARALLEL EXECUTION (pytest-xdist)
# ──────────────────────────────────────────────────────────
# Enable with: pytest -n auto
# Number of workers is determined automatically
#
# Install plugin:
#   pip install pytest-xdist
#
# Examples:
#   pytest -n auto   # Use all cores
#   pytest -n 4      # Use 4 workers


# ──────────────────────────────────────────────────────────
# DOCTEST CONFIGURATION
# ──────────────────────────────────────────────────────────
doctest_optionflags =
    NORMALIZE_WHITESPACE
    ELLIPSIS
    IGNORE_EXCEPTION_DETAIL

# To enable doctest on modules, add to addopts:
#   --doctest-modules


# ──────────────────────────────────────────────────────────
# ASYNCIO SUPPORT (pytest-asyncio)
# ──────────────────────────────────────────────────────────
asyncio_mode = auto

# Explanation:
# auto: Automatically detect async tests/fixtures


# ──────────────────────────────────────────────────────────
# COVERAGE & DIRECTORY EXCLUSIONS
# ──────────────────────────────────────────────────────────
# Detailed coverage config is in pyproject.toml [tool.coverage.*]

norecursedirs =
    .git
    .venv
    venv
    build
    dist
    *.egg-info
    __pycache__
    .pytest_cache
    .mypy_cache
    node_modules
    data
    logs
    backups


# ──────────────────────────────────────────────────────────
# TEST COLLECTION
# ──────────────────────────────────────────────────────────
# Consider namespace packages when collecting tests
consider_namespace_packages = true


# ──────────────────────────────────────────────────────────
# FIXTURES & MOCKING
# ──────────────────────────────────────────────────────────
# Shared fixtures are defined in:
#   tests/conftest.py
#
# Common fixture scopes:
#   function | class | module | session


# ──────────────────────────────────────────────────────────
# ENVIRONMENT VARIABLES FOR TESTS
# ──────────────────────────────────────────────────────────
# Can be managed via pytest-env plugin or in conftest.py.
#
# Example (pytest-env):
# env =
#     TESTING=true
#     LOG_LEVEL=DEBUG
#     MOCK_API_CALLS=true


# ============================================================
# USAGE EXAMPLES
# ============================================================
# Run all tests:
#   pytest
#
# Run specific test file:
#   pytest tests/unit/test_portfolio.py
#
# Run specific test function:
#   pytest tests/unit/test_portfolio.py::test_buy_trade
#
# Run with markers:
#   pytest -m unit
#   pytest -m "not slow"
#   pytest -m "unit or integration"
#
# Run with coverage:
#   pytest --cov=. --cov-report=html
#   open htmlcov/index.html
#
# Run in parallel:
#   pytest -n auto
#   pytest -n 4
#
# Verbose / diagnostics:
#   pytest -v
#   pytest -vv
#   pytest -s
#
# Stop early:
#   pytest -x
#   pytest --maxfail=3
#
# Re-run last failures:
#   pytest --lf
#
# Show slowest tests:
#   pytest --durations=10
#
# CI integration:
#   pytest --junitxml=junit.xml
# ============================================================
